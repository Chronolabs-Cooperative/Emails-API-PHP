/**
 * ZipDownload plugin script
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) The Chronomail Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
window.chronomail&&chronomail.addEventListener("init",function(a){chronomail.register_command("download-eml",function(){chronomail_zipdownload("eml")});chronomail.register_command("download-mbox",function(){chronomail_zipdownload("mbox")});chronomail.register_command("download-maildir",function(){chronomail_zipdownload("maildir")});chronomail.message_list&&chronomail.message_list.addEventListener("select",function(b){b=b.get_selection().length;chronomail.enable_command("download",0<b);chronomail.enable_command("download-eml",1==b);chronomail.enable_command("download-mbox",
"download-maildir",1<b)});chronomail.addEventListener("beforedownload",chronomail_zipdownload_menu);$.each(chronomail.buttons.download||[],function(){var b=$("#"+this.id),a=$("span",b);a.length||(a=$("<span>"),b.html("").append(a));b.attr("aria-haspopup","true");a.text(chronomail.get_label("zipdownload.download"));chronomail.env.download_link=b})});
function chronomail_zipdownload(a){if("eml"==a)a=chronomail.get_single_uid(),chronomail.goto_url("viewsource",chronomail.params_from_uid(a,{_save:1}),!1,!0);else if(chronomail.message_list&&1<chronomail.message_list.get_selection().length){var b=[],e=chronomail.selection_post_data(),c="zipdownload-"+(new Date).getTime(),f=$("<iframe>").attr({name:c,style:"display:none"});c=$("<form>").attr({target:c,style:"display: none",method:"post",action:"?_task=mail&_action=plugin.zipdownload.messages"});e._mode=a;e._token=chronomail.env.request_token;
$.each(e,function(a,d){if("object"==typeof d&&1<d.length)for(var c=0;c<d.length;c++)b.push($("<input>").attr({type:"hidden",name:a+"[]",value:d[c]}));else b.push($("<input>").attr({type:"hidden",name:a,value:d}))});f.appendTo(document.body);c.append(b).appendTo(document.body).submit()}}function chronomail_zipdownload_menu(a){chronomail.command("menu-open","zipdownload-menu",a&&a.target?a.target:chronomail.env.download_link,a);return!1};
