/**
 * (Manage)Sieve Filters plugin
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) The Chronomail Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
window.chronomail&&chronomail.addEventListener("init",function(a){"mail"==chronomail.env.task&&("show"!=chronomail.env.action?chronomail.env.message_commands.push("managesieve-create"):chronomail.enable_command("managesieve-create",!0));"mail"!=chronomail.env.task&&!chronomail.env.action.startsWith("plugin.managesieve")||chronomail.env.framed||(chronomail.env.ms_tip_layer=$('<div id="managesieve-tip" class="popupmenu"></div>'),chronomail.env.ms_tip_layer.appendTo(document.body));chronomail.register_command("plugin.managesieve-save",function(){chronomail.managesieve_save()});
chronomail.register_command("plugin.managesieve-act",function(){chronomail.managesieve_act()});chronomail.register_command("plugin.managesieve-add",function(){chronomail.managesieve_add()});chronomail.register_command("plugin.managesieve-del",function(){chronomail.managesieve_del()});chronomail.register_command("plugin.managesieve-move",function(){chronomail.managesieve_move()});chronomail.register_command("plugin.managesieve-setadd",function(){chronomail.managesieve_setadd()});chronomail.register_command("plugin.managesieve-setdel",function(){chronomail.managesieve_setdel()});
chronomail.register_command("plugin.managesieve-setact",function(){chronomail.managesieve_setact()});chronomail.register_command("plugin.managesieve-setget",function(){chronomail.managesieve_setget()});chronomail.register_command("plugin.managesieve-seteditraw",function(){chronomail.managesieve_seteditraw()});chronomail.env.action.startsWith("plugin.managesieve")&&(chronomail.gui_objects.sieveform?(chronomail.enable_command("plugin.managesieve-save",!0),sieve_form_init()):chronomail.gui_objects.sievesetrawform?(chronomail.enable_command("plugin.managesieve-save",
!0),sieve_raw_editor_init()):(chronomail.enable_command("plugin.managesieve-add",!chronomail.env.sieveconnerror&&-1==$.inArray("new_rule",chronomail.env.managesieve_disabled_actions)),chronomail.enable_command("plugin.managesieve-setadd",!chronomail.env.sieveconnerror&&-1==$.inArray("new_set",chronomail.env.managesieve_disabled_actions))),a=chronomail.env.currentset,chronomail.gui_objects.filterslist&&(chronomail.filters_list=new chronomail_list_widget(chronomail.gui_objects.filterslist,{multiselect:!1,draggable:!0,keyboard:!0}),chronomail.filters_list.addEventListener("select",
function(a){chronomail.managesieve_select(a)}).addEventListener("keypress",function(a){chronomail.list_keypress(a,{del:"plugin.managesieve-del"})}).addEventListener("dragstart",function(a){chronomail.managesieve_dragstart(a)}).addEventListener("dragend",function(a){chronomail.managesieve_dragend(a)}).addEventListener("initrow",function(a){a.obj.onmouseover=function(){chronomail.managesieve_focus_filter(a)};a.obj.onmouseout=function(){chronomail.managesieve_unfocus_filter(a)}}).init()),chronomail.gui_objects.filtersetslist&&
(chronomail.filtersets_list=new chronomail_list_widget(chronomail.gui_objects.filtersetslist,{multiselect:!1,draggable:!1,keyboard:!0}),chronomail.filtersets_list.init().focus(),null!=a&&($("#filterset-name").text(a),a=chronomail.managesieve_setid(a),chronomail.filtersets_list.select(a)),chronomail.filtersets_list.addEventListener("select",function(a){chronomail.managesieve_setselect(a)}),a=chronomail.filtersets_list.rowcount,chronomail.enable_command("plugin.managesieve-set",!0),chronomail.enable_command("plugin.managesieve-setact",0<a&&-1==
$.inArray("enable_disable_set",chronomail.env.managesieve_disabled_actions)),chronomail.enable_command("plugin.managesieve-setget",0<a&&-1==$.inArray("download_set",chronomail.env.managesieve_disabled_actions)),chronomail.enable_command("plugin.managesieve-setdel",1<a&&-1==$.inArray("delete_set",chronomail.env.managesieve_disabled_actions)),chronomail.enable_command("plugin.managesieve-seteditraw",0<a&&chronomail.env.raw_sieve_editor),$("tr",chronomail.gui_objects.filtersetslist).each(function(a,c){chronomail.managesieve_fixdragend(c)})));
chronomail.gui_objects.sieveform&&chronomail.env.rule_disabled&&$("#disabled").attr("checked",!0)});chronomail_webmail.prototype.managesieve_add=function(){this.load_managesieveframe("_nav=hide",!0)};chronomail_webmail.prototype.managesieve_del=function(){var a=this.filters_list.get_single_selection();this.confirm_dialog(this.get_label("managesieve.filterdeleteconfirm"),"delete",function(b,c){b="_act=delete&_fid="+c.filters_list.rows[a].uid;var d=c.set_busy(!0,"loading");c.http_post("plugin.managesieve-action",b,d)})};
chronomail_webmail.prototype.managesieve_act=function(){var a=this.filters_list.get_single_selection(),b=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action","_act=act&_fid="+this.filters_list.rows[a].uid,b)};
chronomail_webmail.prototype.managesieve_select=function(a){var b=a.get_single_selection();null!=b&&(b=a.rows[b].uid,this.load_managesieveframe("_fid="+b));a="undefined"!=typeof b&&null!=b;this.enable_command("plugin.managesieve-act",a);this.enable_command("plugin.managesieve-del",a&&-1==$.inArray("delete_rule",chronomail.env.managesieve_disabled_actions))};
chronomail_webmail.prototype.managesieve_setselect=function(a){this.enable_command("plugin.managesieve-setdel",1<a.rowcount&&-1==$.inArray("delete_set",chronomail.env.managesieve_disabled_actions));this.enable_command("plugin.managesieve-setact",0<a.rowcount&&-1==$.inArray("enable_disable_set",chronomail.env.managesieve_disabled_actions));this.enable_command("plugin.managesieve-setget",0<a.rowcount&&-1==$.inArray("delete_set",chronomail.env.managesieve_disabled_actions));this.enable_command("plugin.managesieve-seteditraw",
0<a.rowcount&&this.env.raw_sieve_editor);chronomail.env.contextmenu_opening||(this.show_contentframe(!1),this.filters_list.clear(!0),a=a.get_single_selection(),null!=a&&(this.managesieve_list(this.env.filtersets[a]),$("#filterset-name").text(this.env.filtersets[a])))};chronomail_webmail.prototype.managesieve_rowid=function(a){var b,c=this.filters_list.rows;for(b in c)if(null!=c[b]&&c[b].uid==a)return b};
chronomail_webmail.prototype.managesieve_setid=function(a){for(var b in this.env.filtersets)if(this.env.filtersets[b]==a)return b};chronomail_webmail.prototype.managesieve_list=function(a){var b=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action","_act=list&_set="+urlencode(a),b)};chronomail_webmail.prototype.managesieve_setget=function(){var a=this.filtersets_list.get_single_selection();this.goto_url("plugin.managesieve-action",{_act:"setget",_set:this.env.filtersets[a]},!1,!0)};
chronomail_webmail.prototype.managesieve_setact=function(){var a=this.filtersets_list.get_single_selection(),b=this.set_busy(!0,"loading"),c=this.env.filtersets[a];a=$("#rcmrow"+a).hasClass("disabled")?"setact":"deact";this.http_post("plugin.managesieve-action","_act="+a+"&_set="+urlencode(c),b)};
chronomail_webmail.prototype.managesieve_setdel=function(){var a=this.filtersets_list.get_single_selection();this.confirm_dialog(this.get_label("managesieve.setdeleteconfirm"),"delete",function(b,c){b=c.env.filtersets[a];var d=c.set_busy(!0,"loading");c.http_post("plugin.managesieve-action","_act=setdel&_set="+urlencode(b),d)})};
chronomail_webmail.prototype.managesieve_seteditraw=function(){var a=this.filtersets_list.get_single_selection();this.load_managesieveframe("_nav=hide&_seteditraw=1&_set="+urlencode(this.env.filtersets[a]),!0)};chronomail_webmail.prototype.managesieve_setadd=function(){this.load_managesieveframe("_nav=hide&_newset=1",!0)};
chronomail_webmail.prototype.managesieve_updatelist=function(a,b){this.set_busy(!0);switch(a){case "del":var c=b.id;a=this.filters_list;a.remove_row(this.managesieve_rowid(b.id));this.show_contentframe(!1);this.reset_filters_list();$("tr",this.filters_list.list).each(function(){if("none"==this.style.display)$(this).detach();else{var a=this.id.substr(6);$(this).off();a>c&&(this.uid=a-1,$(this).attr("id","rcmrow"+this.uid))}});a.init();break;case "update":var d=$("#rcmrow"+this.managesieve_rowid(b.id));
b.name&&$("td",d).text(b.name);b.disabled?d.addClass("disabled"):d.removeClass("disabled");$("#disabled",$("iframe").contents()).prop("checked",b.disabled);break;case "add":a=this.filters_list;d=$('<tr><td class="name"></td></tr>');$("td",d).text(b.name);d.attr("id","rcmrow"+b.id);b.disabled&&d.addClass("disabled");a.insert_row(d.get(0));a.highlight_row(b.id);this.enable_command("plugin.managesieve-del",-1==$.inArray("delete_rule",chronomail.env.managesieve_disabled_actions));this.enable_command("plugin.managesieve-act",
!0);break;case "list":a=this.filters_list;b.clear&&a.clear();for(d in b.list){var e=b.list[d];var g=document.createElement("TR");var k=document.createElement("TD");$(k).text(e.name);k.className="name";g.id="rcmrow"+e.id;e["class"]&&(g.className=e["class"]);g.appendChild(k);a.insert_row(g)}b.set?a.highlight_row(b.set):this.enable_command("plugin.managesieve-del","plugin.managesieve-act",!1);break;case "setact":c=this.managesieve_setid(b.name);d=$("#rcmrow"+c);b.active?(b.all&&$("tr",this.gui_objects.filtersetslist).addClass("disabled"),
d.removeClass("disabled")):d.addClass("disabled");break;case "setdel":c=this.managesieve_setid(b.name);this.filters_list.clear();this.show_contentframe(!1);this.enable_command("plugin.managesieve-setdel","plugin.managesieve-setact","plugin.managesieve-setget","plugin.managesieve-seteditraw",!1);this.filtersets_list.remove_row(c,!0);delete this.env.filtersets[c];break;case "setadd":c="S"+(new Date).getTime();a=this.filtersets_list;d=$('<tr class="disabled"><td class="name"></td></tr>');$("td",d).text(b.name);
d.attr("id","rcmrow"+c);this.env.filtersets[c]=b.name;a.insert_row(d.get(0));b.index!=a.rowcount-1&&(d.detach(),b=$("tr:visible",a.list).get(b.index),d.insertBefore(b));a.select(c);this.managesieve_fixdragend(d);break;case "refresh":this.reset_filters_list(!0)}this.set_busy(!1)};
chronomail_webmail.prototype.reset_filters_list=function(a){this.filters_list.clear_selection();this.enable_command("plugin.managesieve-act","plugin.managesieve-del",!1);a&&(a=this.filtersets_list.get_single_selection(),this.filters_list.clear(!0),this.managesieve_list(this.env.filtersets[a]))};
chronomail_webmail.prototype.load_managesieveframe=function(a,b){b&&this.reset_filters_list();b=this.get_frame_window(this.env.contentframe);a=this.url("plugin.managesieve-action","_framed=1"+(a?"&"+a:""));b&&this.location_href(a,b,!0)};chronomail_webmail.prototype.managesieve_dragstart=function(a){a=this.filters_list.get_single_selection();this.drag_active=!0;this.drag_filter=a};
chronomail_webmail.prototype.managesieve_dragend=function(a){this.drag_active&&(this.drag_filter_target&&(a=this.set_busy(!0,"loading"),this.show_contentframe(!1),this.http_post("plugin.managesieve-action","_act=move&_fid="+this.drag_filter+"&_to="+this.drag_filter_target,a)),this.drag_active=!1)};chronomail_webmail.prototype.managesieve_fixdragend=function(a){var b=this;$(a).on("mouseup"+(bw.iphone||bw.ipad?" touchend":""),function(a){b.drag_active&&b.filters_list.drag_mouse_up(a)})};
chronomail_webmail.prototype.managesieve_focus_filter=function(a){var b=a.id.replace(/^rcmrow/,"");this.drag_active&&b!=this.drag_filter&&(this.drag_filter_target=b,$(a.obj).addClass(b<this.drag_filter?"filtermoveup":"filtermovedown"))};chronomail_webmail.prototype.managesieve_unfocus_filter=function(a){this.drag_active&&($(a.obj).removeClass("filtermoveup filtermovedown"),this.drag_filter_target=null)};
chronomail_webmail.prototype.managesieve_save=function(){if("plugin.managesieve-vacation"==this.env.action){var a=$(this.gui_objects.sieveform).serialize();this.http_post("plugin.managesieve-vacation",a,this.display_message(this.get_label("managesieve.vacation.saving"),"loading"))}else"plugin.managesieve-forward"==this.env.action?(a=$(this.gui_objects.sieveform).serialize(),this.http_post("plugin.managesieve-forward",a,this.display_message(this.get_label("managesieve.forward.saving"),"loading"))):this.gui_objects.sieveform?
(parent.chronomail&&parent.chronomail.filters_list&&"filtersetform"!=this.gui_objects.sieveform.name&&(a=parent.chronomail.filters_list.get_single_selection(),null!=a&&(this.gui_objects.sieveform.elements._fid.value=parent.chronomail.filters_list.rows[a].uid)),this.gui_objects.sieveform.submit()):this.gui_objects.sievesetrawform&&this.gui_objects.sievesetrawform.submit()};chronomail_webmail.prototype.managesieve_ruleadd=function(a){this.http_post("plugin.managesieve-action","_act=ruleadd&_rid="+a)};
chronomail_webmail.prototype.managesieve_rulefill=function(a,b,c){if(""!=a){var d=$("#rules")[0];a=$("<div>").attr({"class":"rulerow",id:"rulerow"+b}).html(a);this.managesieve_insertrow(d,a,c);$('textarea[data-type="list"]',a).each(function(){smart_field_init(this)});this.managesieve_formbuttons(d)}};
chronomail_webmail.prototype.managesieve_ruledel=function(a){$("#ruledel"+a).hasClass("disabled")||this.confirm_dialog(this.get_label("managesieve.ruledeleteconfirm"),"delete",function(b,c){b=document.getElementById("rulerow"+a);b.parentNode.removeChild(b);c.managesieve_formbuttons(document.getElementById("rules"))})};chronomail_webmail.prototype.managesieve_actionadd=function(a){this.http_post("plugin.managesieve-action","_act=actionadd&_aid="+a)};
chronomail_webmail.prototype.managesieve_actionfill=function(a,b,c){if(""!=a){var d=$("#actions")[0];a=$("<div>").attr({"class":"actionrow",id:"actionrow"+b}).html(a);this.managesieve_insertrow(d,a,c);$('textarea[data-type="list"]',a).each(function(){smart_field_init(this)});this.managesieve_formbuttons(d)}};
chronomail_webmail.prototype.managesieve_actiondel=function(a){$("#actiondel"+a).hasClass("disabled")||this.confirm_dialog(this.get_label("managesieve.actiondeleteconfirm"),"delete",function(b,c){b=document.getElementById("actionrow"+a);b.parentNode.removeChild(b);c.managesieve_formbuttons(document.getElementById("actions"))})};
chronomail_webmail.prototype.managesieve_insertrow=function(a,b,c){(c=$("#"+("rules"==$(a).attr("id")?"rulerow":"actionrow")+c)[0])?$(b).insertAfter(c):$(a).append(b);this.triggerEvent("managesieve.insertrow",{obj:b})};chronomail_webmail.prototype.managesieve_formbuttons=function(a){a=$("a.delete",a);a.removeClass("disabled");1==a.length&&a.addClass("disabled")};
chronomail_webmail.prototype.managesieve_vacation_addresses=function(a){var b=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action",{_act:"addresses",_aid:a},b)};chronomail_webmail.prototype.managesieve_vacation_addresses_update=function(a,b){a=$("#vacation_addresses,#action_addresses"+(a||""));smart_field_reset(a.get(0),b)};
function rule_header_select(a){var b=document.getElementById("header"+a),c=document.getElementById("rule_size"+a),d=document.getElementById("rule_message"+a),e=document.getElementById("rule_op"+a),g=document.getElementById("custom_header"+a+"_list"),k=document.getElementById("custom_var"+a+"_list"),m=document.getElementById("rule_mod"+a),n=document.getElementById("rule_trans"+a),t=document.getElementById("rule_comp"+a),p=document.getElementById("rule_mime"+a),q=document.getElementById("rule_mime_part"+
a),u=document.getElementById("rule_date_part"+a),v=document.getElementById("rule_date_header_div"+a),r=$("#rule_op"+a),f=b.value;var l=[e,g,k,m,n,t,c,p,q];"size"==f?(d&&l.push(d),$.each(l,function(){this!=window&&(this.style.display="none")}),c.style.display=""):"message"==f&&d?($.each(l,function(){this!=window&&(this.style.display="none")}),d.style.display=""):(l="body"!=f&&"currentdate"!=f&&"date"!=f&&"string"!=f,g.style.display="..."!=f?"none":"",k.style.display="string"!=f?"none":"",c.style.display=
"none",e.style.display="",t.style.display="",m.style.display=l?"":"none",n.style.display="body"==f?"":"none",p&&(p.style.display=l?"":"none"),q&&(q.style.display=l?"":"none"),d&&(d.style.display="message"==f?"":"none"));u&&(u.style.display="currentdate"==f||"date"==f?"inline":"none");v&&(v.style.display="date"==f?"":"none");$('[value="exists"],[value="notexists"]',r).prop("disabled","string"==f);r.val()||r.val("contains");rule_op_select(e,a,f);rule_mod_select(a,f);rule_mime_select(a);b.style.width=
"..."==f?"40px":""}function rule_op_select(a,b,c){var d=document.getElementById("rule_target"+b+"_list");c||(c=document.getElementById("header"+b).value);d.style.display=a.value.match(/^(exists|notexists)$/)||c.match(/^(size|message)$/)?"none":""}function rule_trans_select(a){var b=document.getElementById("rule_trans_op"+a);document.getElementById("rule_trans_type"+a).style.display="content"!=b.value?"none":"inline"}
function rule_mod_select(a,b){var c=document.getElementById("rule_mod_op"+a),d=document.getElementById("rule_mod_type"+a),e=document.getElementById("rule_duplicate_div"+a),g=document.getElementById("rule_index_div"+a);b||(b=document.getElementById("header"+a).value);d.style.display="address"!=c.value&&"envelope"!=c.value?"none":"";g&&(g.style.display=b.match(/^(body|currentdate|size|message|string)$/)||"envelope"==c.value?"none":"");e&&(e.style.display="message"==b?"":"none")}
function rule_join_radio(a){$("#rules").css("display","any"==a?"none":"block")}function rule_adv_switch(a,b){b=$(b);var c=b.hasClass("hide");a=$("#rule_advanced"+a);c?(a.get(0).style.display="none",b.removeClass("hide").addClass("show")):(a.get(0).style.display="",b.removeClass("show").addClass("hide"))}function rule_mime_select(a){var b=$("#rule_mime_type"+a);a=$("#rule_mime_param"+a+"_list");a.length&&(a[0].style.display="param"==b.val()?"":"none")}
function action_type_select(a){var b=document.getElementById("action_type"+a).value,c={};a={mailbox:document.getElementById("action_mailbox"+a),target:document.getElementById("redirect_target"+a),target_area:document.getElementById("action_target_area"+a),flags:document.getElementById("action_flags"+a),vacation:document.getElementById("action_vacation"+a),forward:document.getElementById("action_forward"+a),set:document.getElementById("action_set"+a),notify:document.getElementById("action_notify"+
a),addheader:document.getElementById("action_addheader"+a),deleteheader:document.getElementById("action_deleteheader"+a)};"fileinto"==b||"fileinto_copy"==b?c.mailbox=1:"redirect"==b||"redirect_copy"==b?c.target=1:b.match(/^reject|ereject$/)?c.target_area=1:b.match(/^(add|set|remove)flag$/)?c.flags=1:b.match(/^(vacation|forward|set|notify|addheader|deleteheader)$/)&&(c[b]=1);for(var d in a)a[d]&&(a[d].style.display=c[d]?"inline":"none")}
function vacation_action_select(){var a=$("#vacation_action").val();$("#action_target_span")["discard"==a||"keep"==a?"hide":"show"]()}
function smart_field_init(a){if(window.UI&&UI.smart_field_init)return UI.smart_field_init(a);var b=a.id+"_list",c=$('<span class="listarea"></span>'),d=a.value?a.value.split("\n"):[""];$("#"+b).length||($.each(d,function(b,d){c.append(smart_field_row(d,a.name,b,$(a).data("size")))}),c.attr("id",b),a=$(a),a.attr("disabled")?c.hide():a.prop("disabled",!0),a.data("hidden")&&c.hide(),a.after(c),a.hasClass("error")&&(c.addClass("error"),chronomail.managesieve_tip_register([[b,a.data("tip-class"),a.data("tip-msg")]])))}
function smart_field_row(a,b,c,d){c=$('<span class="listelement"><span class="reset"></span><input type="text"></span>');a={value:a,name:b+"[]"};d&&(a.size=d);$("input",c).attr(a).keydown(function(a){var b=$(this);if(13==a.which){a=b.attr("name").replace(/\[\]$/,"");var c=(new Date).getTime();a=smart_field_row("",a,c,d);b.parent().after(a);$("input",a).focus()}else if((8==a.which||46==a.which)&&""==b.val()&&(b=b.parent(),1<b.parent().children().length))return b.prev().length?b.prev().children("input").focus():
b.next().children("input").focus(),b.remove(),!1});$('span[class="reset"]',c).click(function(){var a=$(this.parentNode);1<a.parent().children().length?a.remove():$("input",a).val("").focus()});return c}function smart_field_reset(a,b){if(window.UI&&UI.smart_field_reset)return UI.smart_field_reset(a,b);b=b.length?b:[""];area=$("#"+(a.id+"_list"));area.empty();$.each(b,function(b,d){area.append(smart_field_row(d,a.name,b,$(a).data("size")))})}
chronomail_webmail.prototype.managesieve_tip_register=function(a){if(window.UI&&UI.form_errors)return UI.form_errors(a);var b,c=parent.chronomail,d=c?parent.chronomail.env.ms_tip_layer:chronomail.env.ms_tip_layer;for(b in a)$("#"+a[b][0]).data("tip-class",a[b][1]).data("tip-msg",a[b][2]).mouseleave(function(a){d.hide()}).mouseenter(function(a){var b=$(this);a=b.offset();var k=a.left,e=a.top-12,n=b.width();b=$("<span>").addClass(b.data("tip-class")).text(b.data("tip-msg"));c&&(a=$("mail"==chronomail.env.task?"#sievefilterform > iframe":
"#filter-box",parent.document).offset(),e+=a.top,k+=a.left);d.html("").append(b);e-=d.height();d.css({left:k,top:e,minWidth:n-2+"px"}).show()})};
function sieve_formattime(a,b){var c,d="",e=chronomail.env.time_format||"H:i";for(c=0;c<e.length;c++){var g=e.charAt(c);switch(g){case "a":d+=12<=a?"pm":"am";break;case "A":d+=12<=a?"PM":"AM";break;case "g":case "h":d+=("h"==g&&10>a?"0":"")+a;break;case "G":d+=a;break;case "H":d+=(10>a?"0":"")+a;break;case "i":d+=(10>b?"0":"")+b;break;case "s":d+="00";default:d+=g}}return d}
function sieve_form_init(){var a=chronomail.gui_objects.sieveform;"plugin.managesieve"==chronomail.env.action&&"mail"==chronomail.env.task&&parent.chronomail.managesieve_dialog_resize(a);$('input[type="text"]',a).first().focus();$('textarea[data-type="list"]',a).each(function(){smart_field_init(this)});$('[name^="_header"]',a).each(function(){/([0-9]+)$/.test(this.id)&&rule_header_select(RegExp.$1)});$.datepicker&&chronomail.env.date_format&&($.datepicker.setDefaults({dateFormat:chronomail.env.date_format,changeMonth:!0,
showOtherMonths:!0,selectOtherMonths:!0,onSelect:function(a){$(this).focus().val(a)}}),$("input.datepicker").datepicker());$("#vacation_timefrom, #vacation_timeto").attr("autocomplete","off").autocomplete({delay:100,minLength:1,source:function(a,c){var b=[];for(a=0;24>a;a++)b.push(sieve_formattime(a,0));b.push(sieve_formattime(23,59));return c(b)},open:function(a,c){a=$(this);var b=a.val();c=a.autocomplete("widget").css("width","10em");var e=a.data("ui-autocomplete").menu;b&&b.length&&c.children().each(function(){var a=
$(this);0==a.text().indexOf(b)&&e._scrollIntoView(a)})},select:function(a,c){$(this).val(c.item.value);return!1}}).click(function(){$(this).autocomplete("search",$(this).val()||" ")});$("input.error").each(function(){String(this.id).match(/([0-9]+)$/)&&$("#ruleadv"+RegExp.$1+".show").click()})}var cmeditor;function cmCreateErrorElem(a){var b=document.createElement("div");b.style.color="#822";b.innerHTML="\u25cf";b.title=a;return b}
function cmScrollToError(){var a=$(".CodeMirror-lines .line-error"),b=$(".CodeMirror-scroll");a.parent();b.scrollTop(a.offset().top-b.offset().top-Math.round(b.height()/2))}
function sieve_raw_editor_init(){var a=document.getElementById("rawfiltersettxt");a&&!cmeditor&&(cmeditor=CodeMirror.fromTextArea(a,{mode:"sieve",lineNumbers:!0,gutters:["CodeMirror-linenumbers","errorGutter"],styleActiveLine:!0}),$.each(chronomail.env.sieve_errors||[],function(a,c){var b=Number(c.line)-1;cmeditor.addLineClass(b,"background","line-error");cmeditor.setGutterMarker(b,"errorGutter",cmCreateErrorElem(c.msg));a||cmScrollToError()}))}
chronomail_webmail.prototype.managesieve_create=function(a){if(!a&&"show"!=this.env.action){a=this.message_list.get_single_selection();var b=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action",{_uid:a},b)}else if(this.env.sieve_headers&&this.env.sieve_headers.length){a={};var c=this.get_label("managesieve.newfilter"),d=$('<div id="sievefilterform" class="propform"></div>'),e={minWidth:600,minHeight:250,height:300};d.append($("<fieldset>").append($("<legend>").text(this.get_label("managesieve.usedata"))).append($('<ul class="proplist">')));
$.each(this.env.sieve_headers,function(a,b){b={type:"checkbox",name:"headers[]",id:"sievehdr"+a,value:a,checked:!0};var c=chronomail.env.sieve_headers[a][0]+": "+chronomail.env.sieve_headers[a][1];$("ul",d).append($("<li>").append($("<input>").attr(b)).append($("<label>").attr("for","sievehdr"+a).text(c)))});a[this.get_label("managesieve.nextstep")]=function(){var a=$('input[name="headers[]"]:checked',d);if(a.length){var b=chronomail.get_task_url("mail");b=chronomail.add_url(b,"_action","plugin.managesieve");b=chronomail.add_url(b,
"_framed",1);a.map(function(){var a=chronomail.env.sieve_headers[this.value];b=chronomail.add_url(b,"r["+this.value+"]",a[0]+":"+a[1])});a={};var m=$("<iframe>").attr({src:b,frameborder:0});a[chronomail.get_label("save")]=function(){$("iframe",d).get(0).contentWindow.chronomail.managesieve_save()};a[chronomail.get_label("cancel")]=function(){$(this).dialog("destroy")};d.dialog("destroy");chronomail.env.managesieve_dialog=d=chronomail.show_popup_dialog(m,c,a,$.extend(e,{button_classes:["mainaction save","cancel"]}))}else chronomail.alert_dialog(chronomail.get_label("managesieve.nodata"))};
a[this.get_label("cancel")]=function(){$(this).dialog("destroy")};this.env.managesieve_dialog=d=this.show_popup_dialog(d,c,a,$.extend(e,{button_classes:["mainaction next","cancel"]}))}};chronomail_webmail.prototype.managesieve_dialog_close=function(){this.env.managesieve_dialog.dialog("destroy")};
chronomail_webmail.prototype.managesieve_dialog_resize=function(a){var b=this.env.managesieve_dialog,c=$(window),d=$(a);width=$("fieldset",a).first().width();height=d.height();w=c.width();h=c.height();100>height||b.dialog("option",{height:Math.min(h-20,height+120),width:Math.min(w-20,width+65)})};
